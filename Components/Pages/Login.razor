@page "/login"
@using Microsoft.AspNetCore.Identity
@using BlazorDash.Data
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager

<PageTitle>Blazor Dash - Login</PageTitle>

<div class="menu-container">
  <div class="menu-content">
    <h1 class="game-title">üîê Login</h1>
    <p class="tagline">Sign in to save your scores</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="error-message">
        <p>‚ùå @errorMessage</p>
      </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
      <div class="success-message">
        <p>‚úÖ @successMessage</p>
      </div>
    }

    <form @onsubmit="HandleLogin" class="login-form">
      <div class="form-group">
        <label for="username">Username or Email:</label>
        <input type="text" id="username" @bind="username" required class="form-input" />
      </div>

      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" @bind="password" required class="form-input" />
      </div>

      <div class="form-group">
        <label for="rememberMe">
          <input type="checkbox" id="rememberMe" @bind="rememberMe" />
          Remember me
        </label>
      </div>

      <button type="submit" class="btn btn-primary" disabled="@isLoading">
        @if (isLoading)
        {
          <span>Logging in...</span>
        }
        else
        {
          <span>Login</span>
        }
      </button>
    </form>

    <div class="auth-links">
      <p>Don't have an account? <a href="/register">Create one</a></p>
      <p><a href="/">‚Üê Back to Menu (Play without login)</a></p>
    </div>
  </div>
</div>

@code {
  private string username = "";
  private string password = "";
  private bool rememberMe = false;
  private string errorMessage = "";
  private string successMessage = "";
  private bool isLoading = false;

  private async Task HandleLogin()
  {
    try
    {
      isLoading = true;
      errorMessage = "";
      successMessage = "";

      // Attempt sign in
      var result = await SignInManager.PasswordSignInAsync(
          username, password, rememberMe, lockoutOnFailure: false);

      if (result.Succeeded)
      {
        successMessage = "Login successful! Redirecting...";
        await Task.Delay(500);
        NavigationManager.NavigateTo("/");
      }
      else if (result.IsLockedOut)
      {
        errorMessage = "Account is locked. Try again later.";
      }
      else if (result.RequiresTwoFactor)
      {
        // For now, we won't implement 2FA
        errorMessage = "Two-factor authentication is not yet supported.";
      }
      else
      {
        errorMessage = "Invalid username or password.";
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"An error occurred: {ex.Message}";
      Console.WriteLine($"Login error: {ex}");
    }
    finally
    {
      isLoading = false;
    }
  }
}
