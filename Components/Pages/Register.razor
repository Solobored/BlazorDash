@page "/register"
@using Microsoft.AspNetCore.Identity
@using BlazorDash.Data
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager

<PageTitle>Blazor Dash - Register</PageTitle>

<div class="menu-container">
  <div class="menu-content">
    <h1 class="game-title">üìù Register</h1>
    <p class="tagline">Create an account to save your scores</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="error-message">
        <p>‚ùå @errorMessage</p>
      </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
      <div class="success-message">
        <p>‚úÖ @successMessage</p>
      </div>
    }

    @if (!registrationComplete)
    {
      <form @onsubmit="HandleRegister" class="login-form">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" @bind="username" required class="form-input" minlength="3" />
          <small>3+ characters, letters and numbers only</small>
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" @bind="email" required class="form-input" />
        </div>

        <div class="form-group">
          <label for="displayName">Display Name (optional):</label>
          <input type="text" id="displayName" @bind="displayName" class="form-input" maxlength="100" />
          <small>Shown on leaderboard if set</small>
        </div>

        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" @bind="password" required class="form-input" minlength="6" />
          <small>Minimum 6 characters</small>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password:</label>
          <input type="password" id="confirmPassword" @bind="confirmPassword" required class="form-input" />
        </div>

        <button type="submit" class="btn btn-primary" disabled="@isLoading">
          @if (isLoading)
          {
            <span>Creating account...</span>
          }
          else
          {
            <span>Register</span>
          }
        </button>
      </form>
    }
    else
    {
      <div class="success-message">
        <h2>Welcome to Blazor Dash! üéÆ</h2>
        <p>Your account has been created successfully. You can now save your high scores!</p>
      </div>
    }

    <div class="auth-links">
      <p>Already have an account? <a href="/login">Login here</a></p>
      <p><a href="/">‚Üê Back to Menu (Play without account)</a></p>
    </div>
  </div>
</div>

@code {
  private string username = "";
  private string email = "";
  private string displayName = "";
  private string password = "";
  private string confirmPassword = "";
  private string errorMessage = "";
  private string successMessage = "";
  private bool isLoading = false;
  private bool registrationComplete = false;

  private async Task HandleRegister()
  {
    try
    {
      isLoading = true;
      errorMessage = "";
      successMessage = "";

      // Validate inputs
      if (string.IsNullOrWhiteSpace(username))
      {
        errorMessage = "Username is required.";
        isLoading = false;
        return;
      }

      if (username.Length < 3)
      {
        errorMessage = "Username must be at least 3 characters.";
        isLoading = false;
        return;
      }

      if (!System.Text.RegularExpressions.Regex.IsMatch(username, @"^[a-zA-Z0-9_]+$"))
      {
        errorMessage = "Username can only contain letters, numbers, and underscores.";
        isLoading = false;
        return;
      }

      if (password != confirmPassword)
      {
        errorMessage = "Passwords do not match.";
        isLoading = false;
        return;
      }

      if (password.Length < 6)
      {
        errorMessage = "Password must be at least 6 characters.";
        isLoading = false;
        return;
      }

      // Create user
      var user = new ApplicationUser
      {
        UserName = username,
        Email = email,
        DisplayName = string.IsNullOrWhiteSpace(displayName) ? username : displayName,
        CreatedAt = DateTime.UtcNow
      };

      var result = await UserManager.CreateAsync(user, password);

      if (result.Succeeded)
      {
        // Assign default role
        await UserManager.AddToRoleAsync(user, "User");

        // Sign in the user
        await SignInManager.SignInAsync(user, isPersistent: false);

        registrationComplete = true;
        successMessage = "Registration successful! Redirecting...";
        await Task.Delay(2000);
        NavigationManager.NavigateTo("/");
      }
      else
      {
        errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"An error occurred: {ex.Message}";
      Console.WriteLine($"Registration error: {ex}");
    }
    finally
    {
      isLoading = false;
    }
  }
}