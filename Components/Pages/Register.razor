@page "/register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using BlazorDash.Data
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavManager
@inject ILogger<Register> Logger

<PageTitle>Blazor Dash - Register</PageTitle>

<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <h1>ğŸ® Blazor Dash Register</h1>
      <p class="auth-subtitle">Create an account to track your scores</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
      <div class="alert alert-danger" role="alert">
        <span class="alert-icon">âš ï¸</span>
        <div class="alert-content">
          <strong>Error:</strong> @errorMessage
        </div>
      </div>
    }

    <EditForm Model="registerModel" OnValidSubmit="HandleRegister" class="auth-form">
      <DataAnnotationsValidator />
      <ValidationSummary />

      <div class="form-group">
        <label for="displayName">
          <span class="label-icon">ğŸ‘¤</span>
          Display Name
        </label>
        <InputText id="displayName" class="form-control" @bind-Value="registerModel.DisplayName"
          placeholder="Your game name" />
        <ValidationMessage For="@(() => registerModel.DisplayName)" />
      </div>

      <div class="form-group">
        <label for="email">
          <span class="label-icon">ğŸ“§</span>
          Email Address
        </label>
        <InputText id="email" type="email" class="form-control" @bind-Value="registerModel.Email"
          placeholder="your@email.com" />
        <ValidationMessage For="@(() => registerModel.Email)" />
      </div>

      <div class="form-group">
        <label for="password">
          <span class="label-icon">ğŸ”’</span>
          Password
        </label>
        <InputText id="password" type="password" class="form-control" @bind-Value="registerModel.Password"
          placeholder="At least 6 characters" />
        <ValidationMessage For="@(() => registerModel.Password)" />
      </div>

      <div class="form-group">
        <label for="confirmPassword">
          <span class="label-icon">ğŸ”</span>
          Confirm Password
        </label>
        <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="registerModel.ConfirmPassword"
          placeholder="Confirm your password" />
        <ValidationMessage For="@(() => registerModel.ConfirmPassword)" />
      </div>

      <button type="submit" class="btn btn-primary btn-block">
        <span class="btn-icon">âœ¨</span>
        Create Account
      </button>
    </EditForm>

    <div class="auth-footer">
      <p>Already have an account? <a href="/login" class="auth-link">Sign in here</a></p>
      <a href="/" class="auth-link back-link">â† Back to Home</a>
    </div>
  </div>
</div>

@code {
  private RegisterModel registerModel = new();
  private string? errorMessage;

  private class RegisterModel
  {
    [Required(ErrorMessage = "Display name is required")]
    [StringLength(100, MinimumLength = 2, ErrorMessage = "Display name must be between 2 and 100 characters")]
    public string DisplayName { get; set; } = string.Empty;

    [Required(ErrorMessage = "Email is required")]
    [EmailAddress(ErrorMessage = "Invalid email address")]
    public string Email { get; set; } = string.Empty;

    [Required(ErrorMessage = "Password is required")]
    [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters")]
    public string Password { get; set; } = string.Empty;

    [Required(ErrorMessage = "Please confirm your password")]
    [Compare("Password", ErrorMessage = "Passwords do not match")]
    public string ConfirmPassword { get; set; } = string.Empty;
  }

  private async Task HandleRegister()
  {
    try
    {
      var user = new ApplicationUser
      {
        UserName = registerModel.Email,
        Email = registerModel.Email,
        DisplayName = registerModel.DisplayName,
        CreatedAt = DateTime.UtcNow
      };

      var result = await UserManager.CreateAsync(user, registerModel.Password);

      if (result.Succeeded)
      {
        await UserManager.AddToRoleAsync(user, "User");
        Logger.LogInformation("User {Email} registered successfully.", registerModel.Email);
        await SignInManager.SignInAsync(user, isPersistent: false);
        NavManager.NavigateTo("/", forceLoad: true);
      }
      else
      {
        errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
      }
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error during registration");
      errorMessage = "An error occurred during registration. Please try again.";
    }
  }
}