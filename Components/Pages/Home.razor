@page "/"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using BlazorDash.Data
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Blazor Dash - Main Menu</PageTitle>

<div class="menu-container">
  <div class="menu-content">
    <h1 class="game-title">üéÆ Blazor Dash!</h1>
    <p class="tagline">Dodge obstacles. Beat your high score.</p>

    <!-- User Info Section -->
    @if (isAuthenticated)
    {
      <div class="user-header">
        <div class="user-info">
          <p>Welcome, <strong>@userDisplayName</strong>! üëã</p>
          @if (!string.IsNullOrEmpty(userEmail))
          {
            <small>Logged in as: @userEmail</small>
          }
        </div>
        <button class="btn btn-danger" @onclick="HandleLogout">üö™ Logout</button>
      </div>
    }

    <div class="menu-buttons">
      <a href="/game" class="btn btn-play">
        ‚ñ∂Ô∏è Play Game
      </a>
      <button type="button" class="btn btn-info" @onclick="ToggleHowToPlay">
        ‚ùì How to Play
      </button>
      <a href="/leaderboard" class="btn btn-leaderboard">
        üèÜ Leaderboard
      </a>
      <a href="/character-editor" class="btn btn-info">
        üé® Customize Character
      </a>

      @if (isAuthenticated)
      {
        <a href="/user-profile" class="btn btn-secondary">
          üë§ My Profile
        </a>
      }
      else
      {
        <div class="auth-buttons">
          <a href="/login" class="btn btn-secondary">üîí Login</a>
          <a href="/register" class="btn btn-secondary">üìù Register</a>
        </div>
      }
    </div>

    @if (showHowToPlay)
    {
      <div class="how-to-play">
        <h2>How to Play</h2>
        <ul>
          <li><strong>Objective:</strong> Avoid obstacles and survive as long as possible!</li>
          <li><strong>Jump:</strong> Press <kbd>SPACE</kbd> or <kbd>‚Üë UP ARROW</kbd> (or tap on mobile)</li>
          <li><strong>Score:</strong> You earn 10 points per second survived</li>
          <li><strong>Difficulty:</strong> Obstacles spawn faster and move faster over time</li>
          <li><strong>Leaderboard:</strong> Your scores are saved automatically</li>
          <li><strong>Optional Login:</strong> Create an account to track scores across sessions</li>
        </ul>
        <button class="btn btn-secondary" @onclick="ToggleHowToPlay">Close</button>
      </div>
    }

    <div class="stats-preview">
      <h3>üìä Game Info</h3>
      @if (isAuthenticated)
      {
        <p>You're logged in! Your scores will be saved to your profile. <a href="/user-profile">View your stats ‚Üí</a></p>
      }
      else
      {
        <p>Play as a guest or create an account to save your progress!</p>
      }
    </div>
  </div>
</div>

@code {
  private bool showHowToPlay = false;
  private bool isAuthenticated = false;
  private string userDisplayName = "";
  private string userEmail = "";

  protected override async Task OnInitializedAsync()
  {
    await CheckAuthenticationState();
  }

  protected override async Task OnParametersSetAsync()
  {
    await CheckAuthenticationState();
  }

  private async Task CheckAuthenticationState()
  {
    try
    {
      var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
      var user = authState.User;
      
      isAuthenticated = user?.Identity?.IsAuthenticated ?? false;
      
      if (isAuthenticated && user != null)
      {
        var username = user.FindFirst(ClaimTypes.Name)?.Value;
        userEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "";
        
        if (!string.IsNullOrEmpty(username))
        {
          var appUser = await UserManager.FindByNameAsync(username);
          if (appUser != null)
          {
            userDisplayName = appUser.DisplayName ?? appUser.UserName ?? "User";
            userEmail = appUser.Email ?? userEmail;
          }
          else
          {
            userDisplayName = username;
          }
        }
        else
        {
          userDisplayName = "User";
        }
      }
      else
      {
        userDisplayName = "";
        userEmail = "";
      }
      
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error checking auth: {ex.Message}");
      isAuthenticated = false;
    }
  }

  private void ToggleHowToPlay()
  {
    showHowToPlay = !showHowToPlay;
  }

  private void HandleLogout()
  {
    try
    {
      NavigationManager.NavigateTo("/logout", forceLoad: true);
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Logout error: {ex.Message}");
      NavigationManager.NavigateTo("/", forceLoad: true);
    }
  }
}