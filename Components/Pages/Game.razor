@page "/game"
@using BlazorDash.Services
@using System.Text.Json
@using Microsoft.JSInterop
@inject GameService GameService
@inject LeaderboardService LeaderboardService
@inject NavigationManager NavManager
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Blazor Dash - Game</PageTitle>

<div class="game-page">
  <div class="game-wrapper">
    <div class="canvas-container">
      <canvas id="gameCanvas" @ref="gameCanvas"></canvas>
    </div> @if (gameState?.IsGameOver == true)
        {
      <div class="game-over-menu">
        <div class="game-over-content">
          <h2>GAME OVER</h2>
          <p class="final-score">Final Score: <strong>@gameState.Score</strong></p>

          @if (!string.IsNullOrEmpty(newHighScoreMessage))
          {
            <p class="new-high-score">üéâ @newHighScoreMessage</p>
          }

          <div class="score-input">
            <label for="playerName">Player Name:</label>
            <input type="text" id="playerName" @bind="playerName" maxlength="50" />
          </div>

          <div class="game-over-buttons">
            <button class="btn btn-primary" @onclick="SaveAndRestart">Save & Play Again</button>
            <a href="/" class="btn btn-secondary">Main Menu</a>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="game-info">
    <a href="/" class="btn btn-small">‚Üê Back to Menu</a>
    @if (!string.IsNullOrEmpty(initializationError))
    {
      <p class="debug-info error">@initializationError</p>
    }
    else if (gameState != null && isGameStarted)
    {
      <p class="debug-info">Score: @gameState.Score | Time: @gameState.ElapsedSeconds.ToString("F1")s | Obstacles: @gameState.Obstacles.Count</p>
    }
    else if (gameState != null && !isGameStarted)
    {
      <p class="debug-info">Initializing game...</p>
    }
    else
    {
      <p class="debug-info">Loading...</p>
    }
  </div>
</div>

@code {
#pragma warning disable CS0649
  private ElementReference gameCanvas;
#pragma warning restore CS0649
  private IJSObjectReference? jsModule;
  private DotNetObjectReference<Game>? dotnetRef;
  private GameState? gameState;
  private string playerName = "Player";
  private string newHighScoreMessage = "";
  private CancellationTokenSource? gameLoopCts;
  private bool isInitialized = false;
  private bool isGameStarted = false;
  private string? initializationError = null;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender && !isInitialized)
    {
      isInitialized = true;
      // Initialize game state immediately so we don't show "Loading..." forever
      gameState = GameService.NewGame();
      await InitializeGame();
    }
  }

  private async Task InitializeGame()
  {
    try
    {
      // Load JavaScript module (always resolve from site root so /game route works)
      var modulePath = new Uri(new Uri(NavManager.BaseUri), "game.js").ToString();
      jsModule = await JS.InvokeAsync<IJSObjectReference>("import", modulePath);

      // Create dotnet reference for JS interop
      dotnetRef = DotNetObjectReference.Create(this);

      // Initialize canvas
      await jsModule.InvokeVoidAsync("init", gameCanvas, dotnetRef);

      // Mark game as ready to start
      isGameStarted = true;
      initializationError = null;

      // Start game loop
      gameLoopCts = new CancellationTokenSource();
      _ = GameLoopAsync(gameLoopCts.Token);
      
      // Force UI update
      await InvokeAsync(StateHasChanged);
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error initializing game: {ex.Message}");
      initializationError = $"Failed to initialize game: {ex.Message}";
      await InvokeAsync(StateHasChanged);
    }
  }

  private async Task GameLoopAsync(CancellationToken cancellationToken)
  {
    // Wait for game to be started before running the loop
    while (!isGameStarted && !cancellationToken.IsCancellationRequested)
    {
      await Task.Delay(100, cancellationToken);
    }

    if (cancellationToken.IsCancellationRequested || gameState == null)
      return;

    float targetDeltaTime = 1f / 60f; // 60 FPS target
    var stopwatch = System.Diagnostics.Stopwatch.StartNew();
    float accumulator = 0f;

    while (!cancellationToken.IsCancellationRequested && gameState != null && isGameStarted)
    {
      float deltaTime = (float)stopwatch.Elapsed.TotalSeconds;
      stopwatch.Restart();
      accumulator += deltaTime;

      // Fixed timestep updates
      while (accumulator >= targetDeltaTime && gameState != null && !gameState.IsGameOver)
      {
        gameState = GameService.Step(gameState, targetDeltaTime);
        accumulator -= targetDeltaTime;
      }

      // Render
      if (jsModule != null && gameState != null)
      {
        try
        {
          var options = new JsonSerializerOptions
          {
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
          };
          var stateJson = JsonSerializer.Serialize(gameState, options);
          await jsModule.InvokeVoidAsync("render", stateJson);
        }
        catch (Exception ex)
        {
          Console.WriteLine($"Render error: {ex.Message}");
        }
      }

      // Update UI
      await InvokeAsync(StateHasChanged);

      // Small delay to prevent 100% CPU
      await Task.Delay(1, cancellationToken);
    }
  }

  [JSInvokable]
  public async Task OnPlayerInput()
  {
    if (gameState != null && !gameState.IsGameOver)
    {
      GameService.PlayerJump(gameState);
      await Task.CompletedTask;
    }
  }

  private async Task SaveAndRestart()
  {
    if (gameState != null)
    {
      try
      {
        // Save score to database
        await LeaderboardService.AddHighScoreAsync(playerName, gameState.Score);

        // Check if it's a new high score
        bool isTopScore = await LeaderboardService.IsTopScoreAsync(gameState.Score);
        if (isTopScore)
        {
          int rank = await LeaderboardService.GetScoreRankAsync(gameState.Score);
          newHighScoreMessage = $"New High Score! You're ranked #{rank}!";
        }
      }
      catch (Exception ex)
      {
        Console.WriteLine($"Error saving score: {ex.Message}");
        newHighScoreMessage = "Score saved locally!";
      }
    }

    // Restart the game
    newHighScoreMessage = "";
    playerName = "Player";
    gameState = GameService.NewGame();
    isGameStarted = true;
    gameLoopCts?.Cancel();
    gameLoopCts = new CancellationTokenSource();
    _ = GameLoopAsync(gameLoopCts.Token);
  }

  async ValueTask IAsyncDisposable.DisposeAsync()
  {
    gameLoopCts?.Cancel();
    gameLoopCts?.Dispose();

    if (jsModule is not null)
    {
      try
      {
        await jsModule.InvokeVoidAsync("cleanup");
        await jsModule.DisposeAsync();
      }
      catch { }
    }

    dotnetRef?.Dispose();
  }
}