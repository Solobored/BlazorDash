@page "/user-profile"
@using BlazorDash.Services
@using BlazorDash.Data
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject LeaderboardService LeaderboardService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Blazor Dash - User Profile</PageTitle>

<div class="menu-container">
  <div class="menu-content">
    <h1 class="game-title">üë§ User Profile</h1>
    <p class="tagline">View your game statistics</p>

    @if (isAuthenticated && !string.IsNullOrEmpty(userName))
    {
      <div class="user-header">
        <div class="user-info">
          <p>Welcome, <strong>@userName</strong>! üëã</p>
        </div>
      </div>
    }

    <div class="profile-card">
      <div class="profile-stats">
        <h2>@(isAuthenticated ? "Your Game Statistics" : "Game Statistics")</h2>
        @if (userStats != null)
        {
          <p><strong>Total Games Played:</strong> @userStats["totalGames"]</p>
          <p><strong>Personal Best:</strong> @userStats["bestScore"]</p>
          <p><strong>Average Score:</strong> @userStats["averageScore"]</p>
        }
        else
        {
          <p>Loading statistics...</p>
        }
      </div>

      @if (isAuthenticated && userScores != null && userScores.Any())
      {
        <div class="recent-scores">
          <h2>Your Recent Scores</h2>
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Score</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var (score, rank) in userScores.Take(10).Select((s, i) => (s, i + 1)))
              {
                <tr>
                  <td class="rank">#@rank</td>
                  <td class="score">@score.Score.ToString("N0")</td>
                  <td class="date">@score.DateAchieved.ToString("MMM dd, yyyy HH:mm")</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      @if (topScores != null && topScores.Any())
      {
        <div class="recent-scores">
          <h2>Top 10 Scores (All Players)</h2>
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Score</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var (score, rank) in topScores.Select((s, i) => (s, i + 1)))
              {
                <tr>
                  <td class="rank">
                    @if (rank == 1)
                    {
                      <span class="medal">ü•á</span>
                    }
                    else if (rank == 2)
                    {
                      <span class="medal">ü•à</span>
                    }
                    else if (rank == 3)
                    {
                      <span class="medal">ü•â</span>
                    }
                    else
                    {
                      <span>#@rank</span>
                    }
                  </td>
                  <td class="player-name">@score.PlayerName</td>
                  <td class="score">@score.Score.ToString("N0")</td>
                  <td class="date">@score.DateAchieved.ToString("MMM dd, yyyy")</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>

    <div class="profile-actions">
      <a href="/game" class="btn btn-play">‚ñ∂Ô∏è Play Again</a>
      <a href="/" class="btn btn-secondary">‚Üê Back to Menu</a>
    </div>
  </div>
</div>

@code {
  private Dictionary<string, string>? userStats;
  private List<HighScore>? topScores;
  private List<HighScore>? userScores;
  private string? currentUserId;
  private string? userName;
  private bool isAuthenticated = false;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      // Check authentication
      var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
      var user = authState.User;
      isAuthenticated = user?.Identity?.IsAuthenticated ?? false;

      if (isAuthenticated && user != null)
      {
        var username = user.FindFirst(ClaimTypes.Name)?.Value;
        if (!string.IsNullOrEmpty(username))
        {
          var appUser = await UserManager.FindByNameAsync(username);
          if (appUser != null)
          {
            currentUserId = appUser.Id;
            userName = appUser.DisplayName ?? appUser.UserName ?? "User";
            
            // Load user-specific scores
            if (!string.IsNullOrEmpty(currentUserId))
            {
              userScores = await LeaderboardService.GetUserScoresAsync(currentUserId);
              
              // Calculate user-specific statistics
              var userBestScore = userScores != null && userScores.Any() ? userScores.Max(s => s.Score) : 0;
              var userTotalGames = userScores?.Count ?? 0;
              var userAverageScore = userScores != null && userScores.Any() ? (int)userScores.Average(s => s.Score) : 0;

              userStats = new Dictionary<string, string>
              {
                { "bestScore", userBestScore.ToString("N0") },
                { "totalGames", userTotalGames.ToString() },
                { "averageScore", userAverageScore.ToString("N0") }
              };
            }
          }
        }
      }

      // Always load top scores for comparison
      topScores = await LeaderboardService.GetTopScoresAsync(10);
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error loading profile: {ex}");
    }
  }
}
